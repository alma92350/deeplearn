<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">

</head>

<body>
  <div>
  	<table id="cmd_panel"></table>
  </div>
  <table>
		<tr><td colspan='3'><input id="webSocket" type="text" size=20 placeHolder="Address to a websocket">
		<input id="reportbtn"  onclick="report.init()" value="Init Report"  type="button">
		</td></tr>
		<tr>
		<td><label><strong>Talk to: </strong></label><select id="sel_unitId"></select></td>
		<td><label><strong>data: </strong></label><input id="data" placeHolder="data" type="text" size=8 value="3000"></td>
		<td><label><strong>Source from: </strong></label><select id="source" onchange="sourceChanged()"></select></td>
		</tr>
  </table>
  <div id="file_manager">
		<table>
			<tr>
					<td>Save As:</td>
					<td><input id="inputFileNameToSaveAs" placeholder="filename" type="text"></td>
					<td><input onclick="saveModelVar()" type="button" value="Save ModelVar"></td>
					<td>
						<input type="checkbox" id="autoSave" name="backup" value="save">
						<label for="autoSave">Auto Save</label>
					</td>

			</tr>
			<tr>
					<td>Open:</td>
					<td><input type="file" id="fileToLoad"></td>
					<td><input onclick="loadModelVar()" type="button" value="Load ModelVar"><td>
					
			</tr>
			<tr>
				<td><label for="display_model">Display Model</label></td>
				<td><input id="display_model" onclick="displayModel()" type="button" value="source"></td>
			</tr>
		</table>
  </div>
      
  <div id="wrapper">
  	<div id="chat_box" class="content"></div>
    
		<div id="footer">
			<div id="displayParam" class="content"></div>
			<div id="displayPort" class="content"></div>
		</div>
  </div>
  

<script>
/////////////////////////
////// Commands /////////
/////////////////////////
var CommandNames = [
	'reload',
	'getcmds',
	'hi',
	'help'
];
///////////////////////////
////// Draw Commands //////
///////////////////////////
function drawCommands(){
	const cmdByRow = 8;
	const cmdPanel = document.getElementById("cmd_panel");
	var tableBody = "";
	for(var i=0;i<CommandNames.length;i+=cmdByRow){
		var row = "<tr>";
		for(var btn=0; (btn<cmdByRow)&&((i+btn)<CommandNames.length);btn++){
			row += '<td><input id="'+CommandNames[btn+i]+'btn"  value="'+CommandNames[btn+i]+'"  type="button"></td>';
			console.log(btn+i);
		};
		row += "</tr>";
		tableBody += row;
		//console.log(tableBody,i);	
	};

	cmdPanel.innerHTML = tableBody;

	function addEvent(idx){
		var btn = document.getElementById(CommandNames[idx]+'btn');
		btn.addEventListener('click', ()=>{console.log(idx);report.sendTo(CommandNames[idx])});
	}

	for(var i=0;i<CommandNames.length;i++){
		addEvent(i);
	};
}
/////////////////////////
///// reporting /////////
/////////////////////////
var report = {
	name : 'firefox',
	ws : null,
	modelVar: {},
	processResponse: function(payload){
				try{
					var error = payload.message.toLowerCase().indexOf('error')>=0;
				} catch(err){
					return;
				}
				createUserMessage(payload.user, payload.message,error);

				var chat = document.getElementById('chat_box');
				chat.scrollTop = chat.scrollHeight;
				switch(payload.message) {
					case 'last unlabeled predictions':
						report.modelVar[payload.user + '.lup'] = payload.data;
						updateSources(); // update source drop list
						console.log(payload.data);
						createSystemMessage("Available data source: " + Object.keys(report.modelVar));
						break;
						
					case 'hello!':
					case '[Connected]':
						updateConnectedUnits(payload.user);
						break;
						
					case 'commands':
						CommandNames = payload.data;
						drawCommands();
						break;
						
					case 'modelVar':
						report.modelVar[payload.user] = payload.data;
						updateSources(); // update source drop list
						console.log(payload.data);
						createSystemMessage("Available data source: " + Object.keys(report.modelVar));
						var autoSave = document.getElementById('autoSave');
						if(autoSave.checked)
							saveModelVar(payload.user);
						break;
												
					default:
						break;
				}
			},
	init : function(){
				// wsUri = "wss://example.com/ws/websoket";
				var wsUri = document.getElementById('webSocket').value;
				var wsUriLocalStore = localStorage['wsUri'];
				
				var hashes = window.location.hash.substr(1).split('#');
				if(hashes.length){
					wsUri = "wss://" + hashes[0];
					report.name = hashes[1];
					if(report.name===undefined)
						report.name = 'firefox';
				}
				if(wsUri=="" && wsUriLocalStore=="") {
					console.log("report not initialized!!");
					return;
				}
				
				if(wsUri==""){
					document.getElementById('webSocket').value = wsUriLocalStore;
					wsUri = wsUriLocalStore;
				} else {
					localStorage['wsUri'] = wsUri;
				}
				report.ws = new WebSocket(wsUri);
				
				report.ws.onopen = function(ev) {
					createSystemMessage('[Connected]');
					//console.log('[Connected]');
					report.send('hi');
				}

				report.ws.onclose = function(ev) {
					createSystemMessage('[Disconnected]');
					//console.log('[Disconnected]');
				}
				///////////////////////////////////////
				//////// remote control ///////////////
				///////////////////////////////////////
				report.ws.onmessage = function(ev) {
					var payload = JSON.parse(ev.data);
					
					//console.log("["+payload.user+"]: "+payload.message);
					/////// keep alive //////
					clearTimeout(report.timer);
					report.timer = setTimeout(()=>{report.send("coucou!");}, 25000);
					if(payload.user!==report.name)
						report.processResponse(payload);
				}
				
				////////// initialze the interface /////
				drawCommands();
			},
	timer : null,
	send : function(message,toUnit='',data=null){
						var payload = {
							message: message,
							user: report.name + toUnit,
							data: data,
						};
						/////// keep alive //////
						clearTimeout(report.timer);
						report.timer = setTimeout(()=>{report.send("coucou!");}, 25000);
						report.ws.send(JSON.stringify(payload));
					},
	sendTo: function(message){
						var data = document.getElementById("data").value;
						var unitId = getUnitId();
						
						unitId = unitId!==""?'.'+unitId:'';
						
						switch(message){
							case 'setmodel':
								var fromUnitId = getSource(); //document.getElementById("data").value;
								if(fromUnitId===""){
									createSystemMessage("Provide a data source");
									return;
								}
								if(report.modelVar[fromUnitId]===undefined){
									createSystemMessage("No data from this userId: " + fromUnitId);
									createSystemMessage("Available data source: " + Object.keys(report.modelVar));
									return;
								};
								data = report.modelVar[fromUnitId];
								// remove any spaces in labelsUsed
								var dl = data.labelsUsed;
								for(var i=0;i<dl.length;i++){
									dl[i] = dl[i].replace(/\s/g, '');
								}
								break;
								
							case 'setparam':
								
								try{
											data = makeModelParameters();
											
											// remove any spaces in labelsUsed
											var dl = data.labelsUsed;
											for(var i=0;i<dl.length;i++){
												dl[i] = dl[i].replace(/\s/g, '');
											}
											
											createSystemMessage("Model Parameters prepared");
								} catch(err){
									createSystemMessage("Cannot prepare Model Parameters: " + err);
								}
								break;
								
							default:
								break;
						}

						//report.name = 'firefox' + unitId;
						console.log(message);
						report.send(message,unitId,data);
					},
}
report.init();

/////////////////////////////////
/////////// Chat ////////////////
/////////////////////////////////
function createSystemMessage(messageStr) {
	message = document.createTextNode(messageStr);

	var messageBox = document.createElement('p');
	messageBox.className = 'system';

	messageBox.appendChild(message);

	var chat = document.getElementById('chat_box');
	chat.appendChild(messageBox);
	chat.scrollTop = chat.scrollHeight;
}

function createUserMessage(userStr, messageStr,red) {
	user = document.createTextNode(userStr + ': ');

	var userBox = document.createElement('span');
	userBox.className = 'username';
	userBox.appendChild(user);

	var message = document.createTextNode(messageStr);

	var messageBox = document.createElement('p');
	messageBox.appendChild(userBox);
	messageBox.appendChild(message);
	
	if(red) messageBox.setAttribute("style","color:red");

	var chat = document.getElementById('chat_box');
	chat.appendChild(messageBox);
}

function sendMessage() {
	var user = document.getElementById('user');
	var message = document.getElementById('message');

	var payload = {
	  message: message.value,
	  user: user.value
	};

	report.send(message.value);
	message.value = "";
}
////////////////////////////////////
//////// mod var sources ///////////
////////////////////////////////////

function sourceChanged(){
	var modbtn = document.getElementById("display_model");
	modbtn.value = getSource();
	console.log("souce changed: " + modbtn.value);
}

function updateSources(){
	var source = document.getElementById("source");
	var keys = Object.keys(report.modelVar);
	var options = "";
	for(var i=0;i<keys.length;i++){
		options += '<option value="'+ keys[i] +'">' + keys[i] + '</option>';
	}
	source.innerHTML = options;
	sourceChanged();
}

function getSource(){
	var source = document.getElementById("source").options;
	return source[source.selectedIndex].value;	
}
////////////////////////////////////
///////////// Unit Id //////////////
////////////////////////////////////
var connectedUnits = new Set();
updateConnectedUnits('all');
function updateConnectedUnits(unit){
	var sui = document.getElementById("sel_unitId");
	if(connectedUnits.has(unit)) return;
	
	connectedUnits.add(unit);
	
	var options = "";
	for(let unit of connectedUnits){
		options += '<option value="'+ unit +'">' + unit + '</option>';
	}
	//console.log(options);
	sui.innerHTML = options;
}
function getUnitId(){
	var units = document.getElementById("sel_unitId").options;
	var selected = units[units.selectedIndex].value;
	selected = selected==='all'?'':selected;
	return selected;	
}

////////////////////////////////////
/////// file management ////////////
////////////////////////////////////
function saveTextToFile(fileNameToSaveAs,textToSave){
	createSystemMessage("saving: "+ fileNameToSaveAs);
  var textToSaveAsBlob = new Blob([textToSave], {type:"text/plain"});
  var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);	
  var downloadLink = document.createElement("a");
  downloadLink.download = fileNameToSaveAs;
  downloadLink.innerHTML = "Download File";
  downloadLink.href = textToSaveAsURL;
  downloadLink.onclick = destroyClickedElement;
  downloadLink.style.display = "none";
  document.body.appendChild(downloadLink);

  downloadLink.click();
}

function saveModelVar(source){
	var fileNameToSaveAs = document.getElementById("inputFileNameToSaveAs").value;
	createSystemMessage("Available data source: " + Object.keys(report.modelVar));
	if(fileNameToSaveAs===""){
		createSystemMessage("Provide a filename");
		return;
	}
	var fromUnitId = source===undefined?getSource():source;
	if(fromUnitId===""){
		createSystemMessage("Provide a data source");
		return;
	}
	
	var modvar = report.modelVar[fromUnitId];
	if(modvar===undefined){
		createSystemMessage("No data from this userId: " + fromUnitId);
		createSystemMessage("Available data source: " + Object.keys(report.modelVar));
		return;
	};

  var textToSave = JSON.stringify(modvar);
  
  var mp = modvar.modelParam;
	fileNameToSaveAs = fromUnitId + '.' + fileNameToSaveAs    + "-" +
																				mp.conv1OutputDepth + "x" + 
																				mp.conv2OutputDepth + "x" + 
																				mp.filterSize       + "-" +
																				Math.floor(mp.globalStep/1000) +"k.mv";
	
	saveTextToFile(fileNameToSaveAs,textToSave);
}

function destroyClickedElement(event)
{
    document.body.removeChild(event.target);
}

function loadModelVar(){
    var fileToLoad = document.getElementById("fileToLoad").files[0];
 		
    var fileReader = new FileReader();
    fileReader.onload = function(fileLoadedEvent) 
    {
        var textFromFileLoaded = fileLoadedEvent.target.result;
        var data = JSON.parse(textFromFileLoaded);
        var unitId = data.name!==undefined?data.name:'nemo';
        unitId += '(file)';
        //console.log(unitId);
        // remove any spaces in labelsUsed
        //var dl = data.labelsUsed;
        //for(var i=0;i<dl.length;i++){
        //	dl[i] = dl[i].replace(/\s/g, '');
        //}
        
        report.modelVar[unitId] = data;
        updateSources(); // update source drop list
        createSystemMessage("File loaded");
        createSystemMessage("Available data source: " + Object.keys(report.modelVar));
    };
    fileReader.readAsText(fileToLoad, "UTF-8");	
}

////////////////////////////////////////
///////// display modelVar /////////////
////////////////////////////////////////

function saveModelParameters(){
	var mp = makeModelParameters();
		
	var textToSave = JSON.stringify(mp);
	var fileNameToSaveAs = 	mp.name + '-' + 
													mp.modelParam.conv1OutputDepth + "x" +
													mp.modelParam.conv2OutputDepth + "x" +
													mp.modelParam.filterSize + '.mp';
	
	saveTextToFile(fileNameToSaveAs,textToSave);
}

function sendModelParameters(){
	report.sendTo('setparam');
}

function makeModelParameters(){
	var data = {modelParam:{}};
	
	// convert into model var format
	data.name = document.getElementById('p_name').value;
	data.target = document.getElementById('p_target').value;
	data.labelsUsed = document.getElementById('p_lbused').value.replace(/\s/g, '').split(',');
	console.log(data);
	data.modelParam.globalStep = parseInt(document.getElementById('p_gstep').value);
	data.modelParam.trainSteps = parseInt(document.getElementById('p_tsteps').value);
	data.modelParam.conv1OutputDepth = parseInt(document.getElementById('p_conv1').value);
	data.modelParam.conv2OutputDepth = parseInt(document.getElementById('p_conv2').value);
	console.log(data);
	data.modelParam.filterSize = parseInt(document.getElementById('p_filter').value);
	data.modelParam.inputImageSize  = 30;
	data.modelParam.learningRate = parseFloat(document.getElementById('p_lrate').value);
	data.modelParam.momentum = parseFloat(document.getElementById('p_momentum').value);
	data.modelParam.outLayerSize = 7;
	
	console.log(data);
	
	return data;
}

function displayModel(){
	var dport = document.getElementById("displayPort");
	var source = getSource();
	if(source===""){
		alert("Provide source information");
		return;
	}
	console.log('source ' + source);
	var modvar = report.modelVar[source];
	
	if(modvar===undefined){
		alert("No data for this source");
		return;
	}
	
	displayModelVarParameters();
	if(modvar.lastPredictions!==undefined){
		displayModelVarPredictions();
	} else {
		dport.innerHTML = "";
	}
}

function displayModelVarParameters(){
	var dport = document.getElementById("displayParam");
	var source = getSource();
	if(source===""){
		alert("Provide source information");
		return;
	}
	console.log('source' + source);
	var modvar = report.modelVar[source];
	
	if(modvar===undefined){
		alert("No data for this source");
		return;
	}
	
	var mp = modvar.modelParam;
	
	var editParam = '<div><table border="1">' +
							 '<tr><td><h2> Model Parameters: </td><td><input id="p_name" type="text" size=20 value="' +
							 modvar.name + '"></h2></td></tr>' +
							 '<tr><td>Global Step: </td><td><input id="p_gstep" type="text" size=20 value="' + 
							 mp.globalStep + '"></td></tr>' +
							 '<tr><td>Train Steps: </td><td><input id="p_tsteps" type="text" size=20 value="' + 
							 mp.trainSteps + '"></td></tr>' +
							 '<tr><td>Input image size: </td><td>' + mp.inputImageSize + '</td></tr>' +
							 '<tr><td>Target: </td><td><input id="p_target" type="text" size=20 value="' + 
							 modvar.target + '"></td></tr>' +
							 '<tr><td>Labels used: </td><td><input id="p_lbused" type="text" size=20 value="' + 
							 modvar.labelsUsed + '"></td></tr>' +
							 '<tr><td>Conv 1 output depth: </td><td><input id="p_conv1" type="text" size=20 value="' + 
							 mp.conv1OutputDepth + '"></td></tr>' +
							 '<tr><td>Conv 2 output depth: </td><td><input id="p_conv2" type="text" size=20 value="' + 
							 mp.conv2OutputDepth + '"></td></tr>' +
							 '<tr><td>Filter size: </td><td><input id="p_filter" type="text" size=20 value="' + 
							 mp.filterSize + '"></td></tr>' +
							 '<tr><td>Learning rate: </td><td><input id="p_lrate" type="text" size=20 value="' + 
							 mp.learningRate + '"></td></tr>' +
							 '<tr><td>Momentum: </td><td><input id="p_momentum" type="text" size=20 value="' + 
							 mp.momentum + '"></td></tr>' +
							 '<tr><td><input onclick="saveModelParameters()" type="button" value="Save Model"></td>' + 
							 '<td><input onclick="sendModelParameters()" type="button" value="Set Parameters"></td></tr>' + 
							'</div></table>';
	
	dport.innerHTML = editParam;
}

function displayModelVarPredictions(){
	var dport = document.getElementById("displayPort");
	var source = getSource(); //document.getElementById("data").value;
	if(source===""){
		alert("Provide source information");
		return;
	}
	console.log(source);
	var modvar = report.modelVar[source];
	
	if(modvar===undefined){
		alert("No data for this source");
		return;
	}
	////////// prediction table /////////////////
	var lp = modvar.lastPredictions;
	var predResults ="";
	var predInfo = "";
	try{
		predInfo = "<div>" + 
									 "<h2> Prediction Info by " + modvar.name + "</h2>" +
									 "<p>Global Step: " + lp.globalStep + "<br>" +
									 "Target: " + lp.target + "<br>" +
									 "Labels used: " + lp.labelsUsed + "<br>" +
									 "Total Samples: " + lp.totalSamples + "<br>" +
									 "Good predictions: " + lp.goodPredictions + "<br>" +
									 "Accuracy: " + 
									 lp.goodPredictions!==''?Math.floor(100* parseInt(lp.goodPredictions)/parseInt(lp.totalSamples)):'--' + "%<br>" +
									 "Less than 50% Probability: " + lp.lessThan50pc + "<br>" +
									 "Less than 90% Probability: " + lp.lessThan90pc +
								"</p></div>";
	
		////////////////
		predResults = "<div>" + lp.in_divPred + "</div>";
	} catch(err){
		console.log(err);
	}
	////////////////
	var ulTable = '<table border="1"> <col width="80"><col width="80"><col width="80"><col width="80"><col width="80">';
	var unlabeled = modvar.lastPredictions.unlabeled;
	var idx=0;
	while(idx<unlabeled.length){
		var row1 = "<tr>";
		var row2 = "<tr>";
		
		row1 += "<td colspan='5' align='center'><img src='" +unlabeled[idx].src + "'></td>";
		for(var col=0;col<5;col++,idx++){
			
			row2 += '<td align="center"><label> ' + unlabeled[idx].pred +': '+ unlabeled[idx].proba +'%</label></td>';
		}
		ulTable += row1 + '</tr>' + row2 + '</tr>';
	}
	ulTable += "</table>";
	
	dport.innerHTML = predInfo + predResults + "<br>" + ulTable;
}

</script>

<style type="text/css">
	* {
	  font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
	  font-style: italic;
	  font-size: 18px;
	}

	html, body, #wrapper {
   margin: 0;
   padding: 0;
  }
  
  #file_manager {
    color: #fff;
    background-color: #2980b9;
  }

	#wrapper {
    background-color: #ecf0f1;
  }

  #chat_box {
    box-sizing: border-box;
    height: 400px;
    overflow: auto;
    padding-bottom: 200px;
  }
  
   #displayPort,#displayParam {
		margin: 10;
		padding:10;
    color: #fff;
    background-color: #2980b9;
  }

  #footer {
    box-sizing: border-box;
    bottom: 0;
    position: relative;
    width: 80%;
    background-color: #2980b9;
  }

  #footer .content {
    padding-top: 4px;
    position: relative;
  }

  #user { width: 20%; }
  #message { width: 68%; }
  #send_btn {
    width: 10%;
    position: absolute;
    right: 0;
    bottom: 0;
    margin: 0;
  }

  .content {
    width: 70%;
    margin: 0 auto;
  }

  input[type="text"],
  input[type="button"] {
    border: 0;
    color: #fff;
  }

  input[type="text"] {
    background-color: #146EA8;
    padding: 3px 10px;
  }

  input[type="button"] {
    background-color: #f39c12;
    border-right: 2px solid #e67e22;
    border-bottom: 2px solid #e67e22;
    min-width: 70px;
    display: inline-block;
  }

  input[type="button"]:hover {
    background-color: #e67e22;
    border-right: 2px solid #f39c12;
    border-bottom: 2px solid #f39c12;
    cursor: pointer;
  }

  .system,
  .username {
    color: #aaa;
    font-style: italic;
    font-family: monospace;
    font-size: 14px;
  }

  @media(max-width: 1000px) {
    .content { width: 90%; }
  }

  @media(max-width: 780px) {
    #footer { height: 191px; }
    #chat_box { padding-bottom: 191px; }
    #displayPort,#displayParam { padding-bottom: 191px; }

  }

  @media(max-width: 400px) {
    #footer { height: 235px; }
    #chat_box { padding-bottom: 235px; }
    #displayPort,#displayParam { padding-bottom: 235px; }
  }
</style>
</body>
</html>
