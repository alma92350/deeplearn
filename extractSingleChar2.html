<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<script src="montreal_files/deeplearnlatest.js"></script>
<script src="singleCharGenerator1.js"></script>
<script src="capSingleModel2.js"></script>
</head>

<body>
  <canvas id="canvas_ori"></canvas><br>
  <canvas id="canvas_out"></canvas><br>
  <canvas id="canvas_out2"></canvas><br>
  
  <div>
  <input id="generatebtn" value="Generate" onclick="generate()" type="button">
	<input id="loadbtn" value="Load" onclick="load()" type="button">
	<input id="trainbtn1" value="Train (initial)" type="button">
	<br>
	<input id="predictbtn" value="Predict" type="button">
	<input id="trainbtn2" value="Train (wrong)" type="button">
	<input id="trainbtn3" value="Train (probability)" type="button">
	<br>
	<input id="runbtn"   value="RUN"   onclick="Scheduler.run()"    type="button">
	<input id="pausebtn" value="PAUSE" onclick="Scheduler.pause()"  type="button">
	<input id="stopbtn"  value="STOP"  onclick="Scheduler.stop()"   type="button">
	<br>
	<input id="initbtn"  value="INIT"  onclick="initialize()" type="button">
	<input id="savebtn"  value="Save"  onclick="saveModelVariablesToLocalStorage()" type="button">
	<input id="restorebtn"  value="Restore"  onclick="restoreModelVariablesFromLocalStorage()" type="button">
  </div>
  <br>
  <img id="image_ori" src=""><br>
  <input id="webSocket" type="text" size=20 placeHolder="Address to a websocket">
  <input id="reportbtn"  value="Init Report" onclick="report.init()" type="button">
  <br>
  <input id="input_label" type="text" size=5 value="90">
	<label id="lab_count">0</label>
  <div   id="div_results"></div>
  <div   id="div_predictions"></div>
</body>

<script>
var inputImageDataStack = [];
</script>
<script src="extractSingleChar2.js"></script>

<script>
//////////////////////////////////////////////////////
/////////// Filter Focus solution ////////////////////
//// build the filters from the char set         /////
//// use conv and filters to detect the char set /////
//////////////////////////////////////////////////////
function drawLocation(layer0){
	var center_x = layer0.max([1]).argMax().dataSync()[0];
	var center_y = layer0.max([2]).argMax().dataSync()[0];
	var score    = layer0.max().dataSync()[0];
	
	const canvas = document.getElementById("canvas_ori");
	const ctx = canvas.getContext("2d");
	
	ctx.strokeStyle="#FFFFFF";
	ctx.strokeRect(center_x-11,center_y-11,21,21);
	//ctx.strokeRect(0,0,21,21);
	return {x:center_x, y:center_y, score: score};
}

function test(target){
	createTestImage();
	
	filterFocus.initialize();
	
	filterFocus.makeFilters(target);
	
	filterFocus.makeInputXs();
	
	var layer0 = filterFocus.model(filterFocus.inputXs);
	
	return drawLocation(layer0);
}

function createTestImage(){
	const canvas = document.getElementById("canvas_ori");
	const ctx = canvas.getContext("2d");
	canvas.width = 100;
	canvas.height = 30;
		
	const inpLabel =  document.getElementById("input_label");
	const label = inpLabel.value;
	
	ctx.fillStyle="black";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  
	ctx.font = FONT;
	
	ctx.fillStyle="white";
  ctx.fillText(label,5,20);
  inputImageDataStack = [ctx.getImageData(0,0,canvas_ori.width, canvas_ori.height)];
}

// get image from inputImageDataStack using the Target elements
// create a filterStack
var filterFocus = {
	filterStack : {},
	INPUT_IMAGE_WIDTH: 100,
	INPUT_IMAGE_HEIGHT: 30,
	STRIDES_1: 1,
};

filterFocus.makeFilters = function(target){
	var xs = [];
	for(var i=0;i<iDataStack.length;i++){
		var data = iDataStack[i];
		
		if(data.label == target){
			xs.push(makeTensorFromPixels(data));
		}
	}

	filterFocus.filterStack = dl.tidy(() => {
			return xs[1]; //dl.stack(xs,2);
		});
};

filterFocus.makeInputXs = function(){
	var xs=[];
	for(var i=0 ;i<inputImageDataStack.length;i++){
		var data = inputImageDataStack[i];
		xs.push(makeTensorFromPixels(data).as2D(filterFocus.INPUT_IMAGE_WIDTH, filterFocus.INPUT_IMAGE_HEIGHT));
	};
	filterFocus.inputXs = dl.tidy(() => {
			return xs[0]; //dl.stack(xs,0);
		});
}

filterFocus.initialize = function(){
	filterFocus.INPUT_IMAGE_WIDTH = inputImageDataStack[0].width;
	filterFocus.INPUT_IMAGE_HEIGHT = inputImageDataStack[0].height;

}

// compute convolution over the input image for each filter
filterFocus.model = function(inputXs) {	//: dl.Tensor2D : dl.Tensor2D
  const xs = inputXs.as4D(-1, filterFocus.INPUT_IMAGE_HEIGHT, filterFocus.INPUT_IMAGE_WIDTH, 1);

  const strides1 = filterFocus.STRIDES_1;
  const pad1 = 0;

  const layer1 = dl.tidy(() => {
    return xs.conv2d(filterFocus.filterStack.as4D(CANVAS_SIZE,CANVAS_SIZE,1,1), 1, 'same');
        //.relu();
        //.maxPool([2, 2], strides1, pad1);
  });
  
  return layer1;
}

// display the resulting vector
 

</script>

