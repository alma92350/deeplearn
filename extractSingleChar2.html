<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<script src="montreal_files/deeplearnlatest.js"></script>
<script src="singleCharGenerator2.js"></script>
<script src="capSingleModel2.js"></script>
</head>

<body>
  <canvas id="canvas_ori"></canvas><br>
  <canvas id="canvas_out"></canvas><br>
  <canvas id="canvas_out2"></canvas><br>
  
  <div>
  <input id="generatebtn" value="Generate" onclick="generate()" type="button">
	<input id="loadbtn" value="Load" onclick="load()" type="button">
	<input id="trainbtn1" value="Train (initial)" type="button">
	<br>
	<input id="predictbtn" value="Predict" type="button">
	<input id="trainbtn2" value="Train (wrong)" type="button">
	<input id="trainbtn3" value="Train (probability)" type="button">
	<br>
	<input id="runbtn"   value="RUN"   onclick="Scheduler.run()"    type="button">
	<input id="pausebtn" value="PAUSE" onclick="Scheduler.pause()"  type="button">
	<input id="stopbtn"  value="STOP"  onclick="Scheduler.stop()"   type="button">
	<br>
	<input id="initbtn"  value="INIT"  onclick="initialize()" type="button">
	<input id="savebtn"  value="Save"  onclick="saveModelVariablesToLocalStorage()" type="button">
	<input id="restorebtn"  value="Restore"  onclick="restoreModelVariablesFromLocalStorage()" type="button">
  </div>
  <br>
  <img id="image_ori" src=""><br>
  <input id="webSocket" type="text" size=20 placeHolder="Address to a websocket">
  <input id="reportbtn"  value="Init Report" onclick="report.init()" type="button">
  <br>
  <input id="input_label" type="text" size=5 value="90">
	<label id="lab_count">0</label>
  <div   id="div_results"></div>
  <div   id="div_predictions"></div>
</body>

<script>
var inputImageDataStack = [];
</script>
<script src="extractSingleChar2.js"></script>

<script>
//////////////////////////////////////////////////////
/////////// Filter Focus solution ////////////////////
//// build the filters from the char set         /////
//// use conv and filters to detect the char set /////
//////////////////////////////////////////////////////
var ff = {
	weights : [],
	weightFactor : 30, //40 ok
	filterStack : {},
	INPUT_IMAGE_WIDTH: 100,
	INPUT_IMAGE_HEIGHT: 30,
	STRIDES_1: 1,
	ctx : document.getElementById("canvas_ori").getContext("2d"),
	ctxOut : document.getElementById("canvas_out").getContext("2d"),
	ctxOut2 : document.getElementById("canvas_out2").getContext("2d"),
	scores : [],
};

function drawBox(idx,color="#FF0000"){
	ff.ctxOut.strokeStyle=color;
	ff.ctxOut.strokeRect(idx-11,1,21,29);
}

function drawVert(idx,color="#FF0000"){
	ff.ctxOut.strokeStyle=color;
	ff.ctxOut.strokeRect(idx,1,1,29);
}

function drawAllLabels(){
	ff.ctxOut2.fillStyle="black";
  ff.ctxOut2.fillRect(0,0,CANVAS_SIZE,CANVAS_SIZE);
  
	var imgout = ff.ctxOut2.getImageData(0,0,CANVAS_SIZE,CANVAS_SIZE);
	
	for(var i=0;i<iDataStack.length;i++){
		var idata = iDataStack[i];
			for(var j=0; j<idata.data.length; j+=4){
				if(idata.data[j]>0){
					imgout.data[j]   = 255; 
					imgout.data[j+1] = 255;
					imgout.data[j+2] = 255;
				}
			}
	}
	ff.ctxOut2.putImageData(imgout, 0, 0);
}

function drawLabelOnCanvas(x,ctxo=ff.ctxOut,green=true){
	console.log(x.val.label,x.val.filter_idx,x.idx,x.val.y_idx);
	for(var i=0;i<iDataStack.length;i++){
		var idata = iDataStack[i];
		if(idata.label==x.val.label && (i%3==x.val.filter_idx)){
			// change color to green?
			var draw_x = x.idx-10;
			var draw_y = x.val.y_idx-10;
			var imgout = ctxo.getImageData(draw_x,draw_y,CANVAS_SIZE,CANVAS_SIZE);
			for(var j=0; j<idata.data.length; j+=4){
				if(idata.data[j]>0){
					imgout.data[j] = green?0:Math.max(idata.data[j],imgout.data[j]);
					imgout.data[j+1] = idata.data[j];
					imgout.data[j+2] = green?0:Math.max(idata.data[j+2],imgout.data[j+2]);
				}
			};
			ctxo.putImageData(imgout, draw_x, draw_y);
		}
	}
}

function drawLocation(layer0){
	var center_x = layer0.max([1]).argMax().dataSync()[0];
	var center_y = layer0.max([2]).argMax().dataSync()[0];
	var score    = layer0.max().dataSync()[0];
	
	//ff.ctxOut.strokeStyle="#FFFFFF";
	//ff.ctxOut.strokeRect(center_x-11,center_y-11,21,21);
	//ctx.strokeRect(0,0,21,21);
	return {x:center_x, y:center_y, score: score};
}
function graphToLabelNear(idx,d=5){
	var res=[];
	for(var i=idx-d;i<=idx+d;i++){
		if(i>=0 && i<=100){
			res.push(topsAt(i,1)[0].label);
		}
	}
	return res;
}
function topsAt(idx,n=5){
	var col=[];
	for(var j=0;j<ff.scores.length;j++){ // 75
		col.push({label: ff.scores[j].label, filter_idx:j%3, val:ff.scores[j].graph[idx],y_idx:ff.scores[j].y_idx});
	}
	//console.log(col);
	var sortedMax = col.sort((a, b)=>{return (b.val-a.val)});
	return sortedMax.slice(0,n);
}

function topsNear(idx){
	return [topsAt(idx-1,3),topsAt(idx,3),topsAt(idx+1,3)];
}

function nLocalMaxesOf(arr){
	var newArray = Array.from(arr,(x,i)=>{return {idx:i,val:x};});
	//console.log(newArray);
	var localMax=[];
	for(var i=1;i<newArray.length-1;i++){
		if(newArray[i-1].val.val<newArray[i].val.val && newArray[i+1].val.val<newArray[i].val.val){
			localMax.push(newArray[i]);
		}
	}
	//console.log(localMax);
	var sortedMax = localMax.sort((a, b)=>{return (b.val.val-a.val.val)});
	return sortedMax;
}

function findCharXLocations(){
	var idxs = [];
	for(var i=0; i<ff.scores[0].graph.length;i++){ // 100
		var col=[];
		for(var j=0;j<ff.scores.length;j++){ // 75
			col.push({label: ff.scores[j].label, filter_idx:j%3, val:ff.scores[j].graph[i],y_idx:ff.scores[j].y_idx});
		}
		//console.log(col);
		var sortedMax = col.sort((a, b)=>{return (b.val-a.val)});
	
		if(sortedMax.length)
			idxs.push(sortedMax[0]);
		else
			idxs.push({filter_idx:75,val:0});
	}
	console.log(idxs);
	return idxs;
}

function test(target){
	//var value = createTestImage()-(3000*255);
	
	//ff.initialize();
	
	//ff.makeFilters(target);
	for(var i=0;i<iDataStack.length;i++){
		var data = iDataStack[i];
		
		if(data.label == target){
			ff.makeAFilter(data);
			//console.log('made a filter');
			var layer0 = ff.model(ff.inputXs);
			//console.log('layer0 computed');
			//var loc = drawLocation(layer0);
			//loc.data = data;
			//loc.score = loc.score / ff.weights[data.label];
			
			//ff.loc.push(loc);
			
			ff.scores.push({
												graph: Array.from(layer0.max([1]).dataSync(),(x)=>{return (x/ff.weights[data.label]);}), // /ff.weights[data.label]
												y_idx: layer0.max([2]).argMax().dataSync()[0],
												filter: i%3, 
												label: data.label
											});
			
			//ff.ys.push(Array.from(layer0.max([2]).dataSync()));
			
			//console.log(target + ': x: ' + loc.x + ', y: ' + loc.y +' score: ' + loc.score); 
		}
	}
	
	//ff.makeInputXs();
	
	
}
//console.log(x.val.label,x.val.filter_idx,x.idx,x.val.y_idx);
function createTestImage(){
	var width = 100;
	var height = 30;
	var loc_x = [15,30,47,67,87];
	var loc_y = [11,9,15,13,11];
		
	const labels =  document.getElementById("input_label").value.split(',');
	
	ff.ctx.fillStyle="black";
  ff.ctx.fillRect(0,0,width,height);
  ff.ctxOut.fillStyle="black";
  ff.ctxOut.fillRect(0,0,width,height);
  
  for(var i=0; i<labels.length;i++){
  	var fidx = 1;
  	
  	switch(labels[i][1]){
  		case '+':
  			fidx = 2;
  			break;
  		case '-':
  			fidx = 0;
  			break;
  		default:
  			fidx = 1;
  	}
  	
  	drawLabelOnCanvas({
  						idx:loc_x[i],
  						val: { 
  										label:labels[i][0],
  										filter_idx:fidx,
  										y_idx:loc_y[i],
  									}
  					},ff.ctx,false);
  }
  
  inputImageDataStack = [ff.ctx.getImageData(0,0,width, height)];
	
}

function createTestImage_0(){
	var width = 100;
	var height = 30;
		
	const inpLabel =  document.getElementById("input_label");
	const label = inpLabel.value;
	
	ff.ctx.fillStyle="black";
  ff.ctx.fillRect(0,0,width,height);
  
	ff.ctx.font = FONT;
	
	ff.ctx.fillStyle="white";
  ff.ctx.fillText(label,5,20);
  inputImageDataStack = [ff.ctx.getImageData(0,0,width, height)];
  
  var value=0;
  for(var i=0;i<12000;i++)
  	value += inputImageDataStack[0].data[i];
  
  return value;
  //console.log('display value: ' + (value/255));
}

// get image from inputImageDataStack using the Target elements
// create a filterStack
ff.makeAFilter = function(data){

	ff.filterStack = dl.tidy(() => {
			return makeTensorFromPixels(data); //xs[1]; //dl.stack(xs,2); //
		});
}

ff.makeFilters = function(target){
	var xs = [];
	for(var i=0;i<iDataStack.length;i++){
		var data = iDataStack[i];
		
		if(data.label == target){
			xs.push(makeTensorFromPixels(data));
		}
	}

	ff.filterStack = dl.tidy(() => {
			return xs[1]; //dl.stack(xs,2); //
		});
}

ff.makeTensorFromPixels = function(idata){ //NOP DOES NOT WORK
	const x_tensor = dl.tidy(() => {
		return dl.cast(dl.fromPixels(idata).slice([0,0,0],[idata.width,idata.height,1]).squeeze(),"float32").div(dl.scalar(255.0,"float32"));
	});
	
	return x_tensor;
}

ff.makeInputXs = function(sample=-1){
	var xs=[];
	for(var i=0 ;i<inputImageDataStack.length;i++){
		var data = inputImageDataStack[i];
		xs.push(makeTensorFromPixels(data));//.as2D(ff.INPUT_IMAGE_WIDTH, ff.INPUT_IMAGE_HEIGHT));
	};
	ff.inputXs = dl.tidy(() => {
			sample = sample<0?inputImageDataStack.length-1:sample;
			return xs[sample]; //dl.stack(xs,0);
		});
}

ff.initialize = function(){
	ff.INPUT_IMAGE_WIDTH = inputImageDataStack[0].width;
	ff.INPUT_IMAGE_HEIGHT = inputImageDataStack[0].height;
	
	//var idata = ff.ctxOut.getImageData(0,0,canvas_out.width,canvas_out.height);
	//ff.ctxOut2.putImageData(idata,0,0);

	
}

// compute convolution over the input image for each filter
ff.model = function(inputXs) {	//: dl.Tensor2D : dl.Tensor2D
  const xs = inputXs.as4D(-1, inputXs.shape[0], inputXs.shape[1], 1);

  const strides1 = ff.STRIDES_1;
  const pad1 = 0;

  const layer1 = dl.tidy(() => {
    return xs.conv2d(ff.filterStack.as4D(CANVAS_SIZE,CANVAS_SIZE,1,1), 1, 'same');
        //.relu();
        //.maxPool([2, 2], strides1, pad1);
  });
  
  return layer1;
}

// display the resulting vector

function testAllChar(sample){
	//createTestImage();//-(3000*255);
	
	ff.initialize(); console.log('initialized');
	ff.makeInputXs(sample); console.log('made input xs');
	
	// weights
	var weight=0;
	for(var i=0;i<iDataStack.length;i++){
		if(iDataStack[i].label!=='none'){
			for(var j=0;j<(21*21*4);j+=4){
				weight += iDataStack[i].data[j]*iDataStack[i].data[j]/255/255;
			}
			if((i+1)%3==0){
				ff.weights[iDataStack[i].label] = Math.log(weight/ff.weightFactor);
				console.log(iDataStack[i].label + ' weight: ' + ff.weights[iDataStack[i].label]);
				weight=0;
			};
		}
	}
	
	ff.filterStack = {};
	ff.scores = [];
	ff.ys = [];
	ff.dl_layers=[];
	
	ff.ctx.beginPath();
	for(let label of _LABELS){
		if(label!=='none')
			test(label);
	};
	
	var top = nLocalMaxesOf(findCharXLocations()).slice(0,15);
	console.log(top);
	var col=[null,null,null,null,null];
	for(var i=0; i<top.length; i++){
		//drawBox(top[i].idx);
		if(top[i].idx>=(4) && top[i].idx<=(18) && col[0]==null)
				col[0] = top[i];
		if(top[i].idx>=(27) && top[i].idx<=(35) && col[1]==null)
				col[1] = top[i];
		if(top[i].idx>=(47) && top[i].idx<=(53) && col[2]==null)
				col[2] = top[i];
		if(top[i].idx>=(60) && top[i].idx<=(75) && col[3]==null)
				col[3] = top[i];
		if(top[i].idx>=(80) && top[i].idx<=(93) && col[4]==null)
				col[4] = top[i];
		
	}
	ff.ctx.closePath();
	try{
		var res=[];
		var res_i=[];
		for(var i=0; i<col.length;i++){
			var x = col[i];
			if(x!==null){
				switch(x.val.filter_idx){
					case 0:
						res.push(x.val.label+'-');
						break;
					case 1:
						res.push(x.val.label);
						break;
					default:
						res.push(x.val.label+'+');
						break;
				}
				res_i.push(x.idx);
				drawVert(x.idx);
				drawLabelOnCanvas(x);
			} else {
				res.push('?');
				res_i.push('?');
			}
		};
		console.log(res_i);
		console.log(res);
	} catch(err){
		console.log(col);
	}
}

readyNow = testAllChar;

</script>

